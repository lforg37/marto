cmake_minimum_required(VERSION 3.10)
project(PositQuire CXX)

set(VIVADO_INCLUDE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/../include)

add_library(libpositquire STATIC src/posit_dim src/add_sub_quire src/posit_decoder src/posit_mul src/quire_to_posit src/posit_add src/posit_encoder.cpp src/value_prod_conversions) 
target_include_directories(libpositquire PUBLIC ${VIVADO_INCLUDE_DIR} ${CMAKE_CURRENT_SOURCE_DIR}/includes)

OPTION(BUILD_UNIT_TEST "Build the operators unit tests") 
if(BUILD_UNIT_TEST)
	find_package(Boost 1.55 REQUIRED COMPONENTS unit_test_framework)
	enable_testing()

	add_executable(testConvert_exe tests/testConvert.cpp)
	find_library(SOFTPOSIT_LIB softposit)
	find_path(SOFTPOSIT_H softposit.h)
	target_link_libraries(testConvert_exe libpositquire ${Boost_LIBRARIES}) 
	if(SOFTPOSIT_LIB AND SOFTPOSIT_H)
		MESSAGE(STATUS "softposit found : ${SOFTPOSIT_LIB}, ${SOFTPOSIT_H}")
		target_compile_definitions(testConvert_exe PRIVATE SOFTPOSIT)
		target_include_directories(testConvert_exe PRIVATE ${SOFTPOSIT_H})
		target_link_libraries(testConvert_exe ${SOFTPOSIT_LIB})

		add_executable(testAritOps_exe tests/testArithmeticOp.cpp)
		target_include_directories(testAritOps_exe PRIVATE ${SOFTPOSIT_H})
		target_compile_options(testAritOps_exe PRIVATE -O3 -fopenmp)
		target_link_libraries(testAritOps_exe libpositquire ${Boost_LIBRARIES} ${SOFTPOSIT_LIB}  -fopenmp) 
		add_test(testAritOps testAritOps_exe)
	else()
		Message(WARNING "Tests on posit value cannot be run")
	endif()

	add_test(testConvert testConvert_exe)
endif()
enable_testing()
